---
phase: 05-integration-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/page.tsx
  - app/components/CommandFeedback.tsx
autonomous: false

must_haves:
  truths:
    - "User sees visual feedback when command is sent"
    - "User sees acknowledgment when extension executes command"
    - "Feedback clears automatically after brief display"
  artifacts:
    - path: "app/components/CommandFeedback.tsx"
      provides: "Command acknowledgment status display component"
      exports: ["CommandFeedback"]
    - path: "app/page.tsx"
      provides: "Integration of CommandFeedback with command buttons"
      contains: "CommandFeedback"
  key_links:
    - from: "app/page.tsx"
      to: "app/components/CommandFeedback.tsx"
      via: "component import and rendering"
      pattern: "import.*CommandFeedback"
    - from: "app/components/CommandFeedback.tsx"
      to: "convex/commands.ts"
      via: "useQuery subscription to getRecent"
      pattern: "useQuery.*getRecent"
---

<objective>
Add command acknowledgment feedback UI to web app controller.

Purpose: Users see visual confirmation that their command was sent AND executed (requirement CONN-03). This completes the feedback loop so users know the extension received and executed their commands.

Output: Web app shows brief acknowledgment indicator after each command is successfully executed by the extension.
</objective>

<execution_context>
@/Users/tannersharon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tannersharon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-integration-polish/05-01-SUMMARY.md
@app/page.tsx
@app/components/ConnectionStatus.tsx
@convex/commands.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommandFeedback component</name>
  <files>app/components/CommandFeedback.tsx</files>
  <action>
Create a new component that shows acknowledgment status for the most recent command:

1. Create `app/components/CommandFeedback.tsx` with:
   - Import useQuery from convex/react and api from @/convex/_generated/api
   - Subscribe to `api.commands.getRecent` with limit: 1 to get most recent command
   - Track local state for "showing" the feedback (auto-dismiss after 2 seconds)

2. Display logic:
   - If no recent command or command older than 5 seconds: show nothing
   - If command is acknowledged: show green checkmark with "Executed" text
   - If command is NOT acknowledged: show yellow spinner with "Sending..." text
   - Use Tailwind for styling, match the ConnectionStatus component style

3. Auto-dismiss:
   - When command acknowledged status changes to true, start 2-second timer
   - After 2 seconds, hide the feedback
   - This prevents stale acknowledgments from lingering

4. Component structure:
```tsx
export function CommandFeedback() {
  const recentCommand = useQuery(api.commands.getRecent, { limit: 1 });
  const [visible, setVisible] = useState(false);
  const [lastCommandId, setLastCommandId] = useState<string | null>(null);

  // Effect to handle visibility and auto-dismiss
  // Show when new command arrives, hide 2s after acknowledgment

  if (!visible || !recentCommand?.[0]) return null;

  const command = recentCommand[0];
  const isAcknowledged = command.acknowledged;

  return (
    <div className="flex items-center gap-2">
      {isAcknowledged ? (
        <>
          <div className="h-2 w-2 rounded-full bg-green-500" />
          <span className="text-sm text-green-600 dark:text-green-400">Executed</span>
        </>
      ) : (
        <>
          <div className="h-2 w-2 rounded-full bg-yellow-500 animate-pulse" />
          <span className="text-sm text-yellow-600 dark:text-yellow-400">Sending...</span>
        </>
      )}
    </div>
  );
}
```

Add the "use client" directive at the top of the file.
  </action>
  <verify>
TypeScript compilation: `npx tsc --noEmit`
  </verify>
  <done>CommandFeedback component created with acknowledgment status display</done>
</task>

<task type="auto">
  <name>Task 2: Integrate CommandFeedback into controller page</name>
  <files>app/page.tsx</files>
  <action>
Add the CommandFeedback component to the controller page:

1. Import CommandFeedback: `import { CommandFeedback } from "./components/CommandFeedback";`

2. Add it to the header, between ConnectionStatus and UserButton:
   - Position it so it's visible but not intrusive
   - Should appear next to the connection status indicator

3. Updated header structure:
```tsx
<div className="flex items-center gap-6">
  <ConnectionStatus />
  <CommandFeedback />
  <SignedIn>
    <UserButton />
  </SignedIn>
</div>
```

The CommandFeedback will automatically show/hide based on command activity.
  </action>
  <verify>
1. Run dev server: `npm run dev`
2. Visit http://localhost:3000
3. Send a command - should see "Sending..." briefly then "Executed"
  </verify>
  <done>CommandFeedback integrated into controller page header</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete command acknowledgment flow:
1. Extension acknowledges commands after successful execution (Plan 05-01)
2. Web app shows visual feedback for command status (this plan)
  </what-built>
  <how-to-verify>
**Setup:**
1. Ensure extension is loaded and reloaded (chrome://extensions)
2. Open pcloud.link video tab with a video loaded
3. Open web app at http://localhost:3000 and sign in
4. Open Convex dashboard to monitor commands table

**Test acknowledgment flow:**
1. Click any command button (e.g., Play)
2. Observe: "Sending..." appears briefly in header
3. Observe: Changes to "Executed" with green indicator
4. Observe: Fades out after 2 seconds
5. Verify in Convex: Command shows acknowledged: true with timestamp

**Test error case (optional):**
1. Close pcloud.link tab
2. Click command button
3. Observe: "Sending..." appears but may not change to "Executed" (no acknowledgment)

**Final v1 requirements verification:**
All 22 requirements should now be working:
- SPIKE-01, SPIKE-02, SPIKE-03: Validated in Phase 0
- AUTH-01, AUTH-02, AUTH-03: Validated in Phase 1
- PLAY-01 through PLAY-12: Validated in Phase 4
- CONN-01: Connection status working
- CONN-02: Extension auto-reconnects
- CONN-03: Command acknowledgment shown (this plan)
- EXT-01, EXT-02, EXT-03: Working since Phase 3-4
- EXT-04: Extension sends acknowledgment (Plan 05-01)

Confirm: "All 22 v1 requirements verified" or describe any issues.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit` passes
2. Dev server runs: `npm run dev` with no errors
3. CommandFeedback shows "Sending..." when command sent
4. CommandFeedback shows "Executed" when acknowledged
5. Feedback auto-dismisses after 2 seconds
6. All 22 v1 requirements verified working end-to-end
</verification>

<success_criteria>
- CONN-03: Web app shows command acknowledgment - COMPLETE
- EXT-04: Extension sends acknowledgment after execution - COMPLETE (Plan 05-01)
- All 22 v1 requirements working
- Project ready for production use
</success_criteria>

<output>
After completion, create `.planning/phases/05-integration-polish/05-02-SUMMARY.md`
</output>
