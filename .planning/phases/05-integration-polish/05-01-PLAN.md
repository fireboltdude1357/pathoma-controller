---
phase: 05-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - extension/background.ts
  - extension/convex-client.ts
  - extension/dist/background.js
autonomous: true

must_haves:
  truths:
    - "Extension calls acknowledge mutation after successful command execution"
    - "Acknowledged commands have acknowledgedAt timestamp in Convex"
    - "Failed command execution does not mark command as acknowledged"
  artifacts:
    - path: "extension/convex-client.ts"
      provides: "acknowledgeCommand function wrapping mutation call"
      exports: ["acknowledgeCommand"]
    - path: "extension/background.ts"
      provides: "acknowledge mutation call after content script response"
      contains: "acknowledgeCommand"
  key_links:
    - from: "extension/background.ts"
      to: "extension/convex-client.ts"
      via: "acknowledgeCommand import and call"
      pattern: "acknowledgeCommand\\(command\\._id\\)"
    - from: "extension/convex-client.ts"
      to: "convex/commands.ts"
      via: "api.commands.acknowledge mutation"
      pattern: "api\\.commands\\.acknowledge"
---

<objective>
Add command acknowledgment flow from Chrome extension to Convex backend.

Purpose: Enables the web app to know when commands have been successfully executed (requirement EXT-04). This is the foundation for showing acknowledgment feedback in the UI (Plan 05-02).

Output: Extension sends acknowledgment mutation after successful video control execution.
</objective>

<execution_context>
@/Users/tannersharon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tannersharon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@convex/commands.ts
@extension/background.ts
@extension/convex-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add acknowledgeCommand function to convex-client.ts</name>
  <files>extension/convex-client.ts</files>
  <action>
Add an exported async function `acknowledgeCommand` that:
1. Takes a commandId parameter (string, the Convex document ID)
2. Gets the Convex client via getConvexClient()
3. Calls the acknowledge mutation: `await client.mutation(api.commands.acknowledge, { commandId })`
4. Returns a promise that resolves when mutation completes

Import the Id type from convex if needed for type safety. The mutation already exists in convex/commands.ts and accepts `{ commandId: v.id("commands") }`.

Export the function so background.ts can import it.
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit -p extension/tsconfig.json`
  </verify>
  <done>acknowledgeCommand function exported from convex-client.ts</done>
</task>

<task type="auto">
  <name>Task 2: Call acknowledgeCommand after successful command execution</name>
  <files>extension/background.ts, extension/dist/background.js</files>
  <action>
Modify the command handling in background.ts to call acknowledgeCommand after successful execution:

1. Import `acknowledgeCommand` from `./convex-client`

2. In the command callback (inside subscribeToCommands), after successfully sending to content script and receiving a success response:
   - Check if the content script response indicates success (response.success === true)
   - If successful, call `await acknowledgeCommand(command._id)`
   - Wrap the acknowledge call in try/catch to handle network errors gracefully
   - Log success: `console.log('[Pathoma Controller] Command acknowledged:', command._id)`
   - Log failure: `console.error('[Pathoma Controller] Failed to acknowledge command:', error)`

3. Do NOT acknowledge if:
   - No pcloud.link tab found
   - Content script returns error (response.success === false)
   - This ensures only successfully executed commands are acknowledged

4. The acknowledgment call should happen AFTER storing lastCommandId (to prevent re-processing) but the acknowledgment failure should not affect command execution.

After modifying, rebuild extension: `npm run build:extension`
  </action>
  <verify>
1. Build succeeds: `npm run build:extension`
2. TypeScript compilation passes: `npx tsc --noEmit -p extension/tsconfig.json`
3. In Convex dashboard, send a command from web app and verify:
   - Command appears with acknowledged: true
   - acknowledgedAt has a timestamp
  </verify>
  <done>
Commands are acknowledged in Convex after successful execution. The acknowledgedAt field is populated when extension successfully executes command on video.
  </done>
</task>

</tasks>

<verification>
1. Build extension: `npm run build:extension` - no errors
2. TypeScript check: `npx tsc --noEmit -p extension/tsconfig.json` - passes
3. Functional test:
   - Load extension in Chrome (chrome://extensions, reload)
   - Open pcloud.link video tab
   - Send command from web app
   - Check Convex dashboard: command should show acknowledged: true and acknowledgedAt timestamp
4. Error handling test:
   - Close pcloud.link tab
   - Send command from web app
   - Check Convex dashboard: command should show acknowledged: false (no tab to execute)
</verification>

<success_criteria>
- Extension calls acknowledge mutation after content script returns success
- Commands show acknowledged: true and acknowledgedAt timestamp in Convex
- Failed executions (no video, no tab) remain acknowledged: false
- Build and TypeScript compilation pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-integration-polish/05-01-SUMMARY.md`
</output>
