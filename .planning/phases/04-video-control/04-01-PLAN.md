---
phase: 04-video-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - extension/content.ts
  - extension/background.ts
  - extension/manifest.json
  - extension/build.mjs
autonomous: true

must_haves:
  truths:
    - "Content script injects into pcloud.link pages"
    - "Service worker forwards commands to content script"
    - "Content script finds video element on page"
    - "Content script controls video via HTMLMediaElement API"
  artifacts:
    - path: "extension/content.ts"
      provides: "Video control via HTMLMediaElement API"
      contains: "document.querySelector('video')"
    - path: "extension/background.ts"
      provides: "Command forwarding to content script"
      contains: "chrome.tabs.sendMessage"
    - path: "extension/manifest.json"
      provides: "Content script registration"
      contains: "content_scripts"
    - path: "extension/dist/content.js"
      provides: "Bundled content script"
  key_links:
    - from: "extension/background.ts"
      to: "extension/content.ts"
      via: "chrome.tabs.sendMessage"
      pattern: "chrome\\.tabs\\.sendMessage"
    - from: "extension/content.ts"
      to: "HTMLMediaElement"
      via: "video element control"
      pattern: "(play|pause|currentTime|playbackRate)"
---

<objective>
Implement content script that executes video commands on pcloud.link via HTMLMediaElement API

Purpose: Complete the command execution pipeline so web app commands actually control video playback
Output: Working content script with all 12 playback controls (play, pause, seek +/- 4 increments, speed +/-)
</objective>

<execution_context>
@/Users/tannersharon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tannersharon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 3 established patterns
@.planning/phases/03-extension-foundation/03-02-SUMMARY.md

# Current extension files
@extension/background.ts
@extension/manifest.json
@extension/build.mjs
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content script with video control functions</name>
  <files>extension/content.ts</files>
  <action>
Create content script that:

1. Finds video element: `document.querySelector('video')` - validated working in Phase 0 spike
2. Implements control functions for each command type:
   - `play`: `video.play()`
   - `pause`: `video.pause()`
   - `seekForward`: `video.currentTime += amount` (amount in seconds)
   - `seekBackward`: `video.currentTime -= amount` (amount in seconds)
   - `speedUp`: `video.playbackRate += amount` (default 0.1)
   - `speedDown`: `video.playbackRate -= amount` (default 0.1)

3. Listen for messages from service worker via chrome.runtime.onMessage
4. Message format: `{ type: CommandType, amount?: number }` matching Convex schema
5. Execute corresponding control function when message received
6. Return success/failure response to sender

Handle edge cases:
- Video not found: Return error, don't crash
- Seek bounds: Clamp currentTime to [0, video.duration]
- Speed bounds: Clamp playbackRate to reasonable range (0.1 to 4.0)

Do NOT add acknowledgment logic (that's Phase 5). Just execute and log.
  </action>
  <verify>File exists at extension/content.ts with video control functions and message listener</verify>
  <done>Content script implements all 6 command types via HTMLMediaElement API</done>
</task>

<task type="auto">
  <name>Task 2: Wire service worker to forward commands to content script</name>
  <files>extension/background.ts</files>
  <action>
Update background.ts to forward commands to content script:

1. In the command handler (inside subscribeToCommands callback), after logging "Command queued":
   - Query active tabs matching pcloud.link pattern: `chrome.tabs.query({ url: '*://*.pcloud.link/*' })`
   - If tab found, send message: `chrome.tabs.sendMessage(tab.id, { type: command.type, amount: command.amount })`
   - Log result (success or error)

2. Handle case when no pcloud.link tab is open:
   - Log warning: "No pcloud.link tab found"
   - Don't crash - just skip execution

3. Handle case when content script not ready:
   - Wrap sendMessage in try/catch
   - Log error if message fails (content script may not be loaded yet)

Remove the TODO comment about Phase 4 - this IS Phase 4.

Message format must match what content.ts expects: `{ type: string, amount?: number }`
  </action>
  <verify>background.ts contains chrome.tabs.query and chrome.tabs.sendMessage calls</verify>
  <done>Service worker forwards all received commands to content script on pcloud.link tabs</done>
</task>

<task type="auto">
  <name>Task 3: Update manifest and build configuration</name>
  <files>extension/manifest.json, extension/build.mjs</files>
  <action>
Update manifest.json to register content script:

```json
"content_scripts": [
  {
    "matches": ["*://*.pcloud.link/*", "*://u.pcloud.link/*"],
    "js": ["dist/content.js"],
    "run_at": "document_idle"
  }
]
```

Also add "tabs" permission (needed for chrome.tabs.query and sendMessage):

```json
"permissions": ["storage", "alarms", "tabs"]
```

Update build.mjs to bundle content script:
- Add second esbuild.build() call for extension/content.ts
- Output to extension/dist/content.js
- Same config as background.ts (esm, es2020, browser)
- Content script doesn't need CONVEX_URL define (no Convex client needed)

Run build after changes: `npm run build:extension`
  </action>
  <verify>
1. `cat extension/manifest.json` shows content_scripts and tabs permission
2. `npm run build:extension` succeeds
3. `ls extension/dist/` shows both background.js and content.js
  </verify>
  <done>Extension bundles content script and manifest registers it for pcloud.link</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run build:extension` completes without errors
2. extension/dist/ contains background.js and content.js
3. manifest.json has content_scripts and tabs permission
4. No TypeScript errors: `npx tsc --noEmit -p extension/tsconfig.json`
</verification>

<success_criteria>
- Content script exists with all 6 command type handlers
- Service worker forwards commands to content script via chrome.tabs.sendMessage
- Manifest registers content script for pcloud.link
- Build produces both bundled scripts
- No errors in TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/04-video-control/04-01-SUMMARY.md`
</output>
