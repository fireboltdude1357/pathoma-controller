---
phase: 01-backend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - convex/schema.ts
  - convex/_generated/
  - next.config.js
  - .env.local
  - tsconfig.json
autonomous: true
user_setup:
  - service: clerk
    why: "User authentication"
    env_vars:
      - name: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard -> API Keys -> Publishable Key"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard -> API Keys -> Secret Key"
    dashboard_config:
      - task: "Create new Clerk application"
        location: "https://dashboard.clerk.com -> Create application"
  - service: convex
    why: "Real-time backend database"
    env_vars:
      - name: CONVEX_DEPLOYMENT
        source: "Auto-generated by npx convex dev"
      - name: NEXT_PUBLIC_CONVEX_URL
        source: "Auto-generated by npx convex dev"

must_haves:
  truths:
    - "Next.js dev server starts without errors"
    - "Convex dev connects to cloud backend"
    - "Users and commands tables exist in Convex dashboard"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies"
      contains: "convex"
    - path: "convex/schema.ts"
      provides: "Database schema definition"
      contains: "defineSchema"
    - path: ".env.local"
      provides: "Environment configuration"
      contains: "CONVEX"
  key_links:
    - from: "convex/schema.ts"
      to: "Convex cloud"
      via: "npx convex dev"
      pattern: "defineSchema"
---

<objective>
Initialize Next.js project with Convex and Clerk dependencies, and define the core database schema.

Purpose: Establish the foundational project structure and data model that all subsequent phases will build upon.
Output: Working Next.js project with Convex schema defining users (for authorization) and commands (for video control) tables.
</objective>

<execution_context>
@/Users/tannersharon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tannersharon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00-feasibility-spike/00-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js project with Convex and Clerk</name>
  <files>
    package.json
    next.config.js
    tsconfig.json
    app/layout.tsx
    app/page.tsx
    .gitignore
  </files>
  <action>
    Create a new Next.js 14+ project with App Router in the current directory (which is empty except for .git and .planning):

    1. Run `npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir=false --import-alias="@/*" --no-turbo` (use current directory, answer yes to overwrite)

    2. Install Convex: `npm install convex`

    3. Install Clerk: `npm install @clerk/nextjs`

    4. Initialize Convex: `npx convex dev --once` (this creates convex/ directory structure)
       - This will prompt for Convex login if not already authenticated
       - Creates convex/ directory with _generated/ folder
       - Sets up .env.local with CONVEX_DEPLOYMENT and NEXT_PUBLIC_CONVEX_URL

    5. Update next.config.js if needed for any Convex/Clerk requirements (usually none needed)

    Note: Do NOT run `convex dev` in persistent mode yet - just `--once` to initialize. The user will need to configure Clerk keys before full dev flow works.
  </action>
  <verify>
    - `npm run build` completes without errors
    - `ls convex/` shows _generated directory
    - `.env.local` contains CONVEX_DEPLOYMENT
  </verify>
  <done>
    Next.js project initialized with Convex and Clerk packages installed, Convex backend provisioned.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define Convex schema for users and commands</name>
  <files>
    convex/schema.ts
  </files>
  <action>
    Create convex/schema.ts with two tables:

    ```typescript
    import { defineSchema, defineTable } from "convex/server";
    import { v } from "convex/values";

    export default defineSchema({
      // Authorized users - admin adds emails directly in Convex dashboard
      users: defineTable({
        email: v.string(),
        name: v.optional(v.string()),
        createdAt: v.number(),
      }).index("by_email", ["email"]),

      // Video control commands sent from web app
      commands: defineTable({
        type: v.union(
          v.literal("play"),
          v.literal("pause"),
          v.literal("seekForward"),
          v.literal("seekBackward"),
          v.literal("speedUp"),
          v.literal("speedDown")
        ),
        // Amount for seek (seconds) or speed change (playbackRate delta)
        amount: v.optional(v.number()),
        // Who sent the command (Clerk user ID)
        userId: v.string(),
        // Timestamp for ordering and deduplication
        createdAt: v.number(),
        // Extension acknowledgment
        acknowledged: v.boolean(),
        acknowledgedAt: v.optional(v.number()),
      }).index("by_createdAt", ["createdAt"]),
    });
    ```

    Design notes:
    - `users` table: Simple email allowlist. Admin adds authorized emails directly in Convex dashboard (AUTH-03).
    - `commands` table: Stores each command with type, amount (for seek/speed), userId, and acknowledgment status.
    - Index on commands.createdAt enables efficient "get latest unacknowledged command" queries.
    - Index on users.email enables fast authorization lookup.
  </action>
  <verify>
    - Run `npx convex dev --once` to push schema to Convex
    - Check Convex dashboard shows `users` and `commands` tables
    - No TypeScript errors in convex/schema.ts
  </verify>
  <done>
    Convex schema deployed with users (authorization) and commands (video control) tables.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create placeholder app structure</name>
  <files>
    app/layout.tsx
    app/page.tsx
    convex/README.md
  </files>
  <action>
    Update the default Next.js files to prepare for Clerk/Convex integration:

    1. Update app/layout.tsx to be a minimal shell (Clerk/Convex providers added in Plan 02):
    ```typescript
    import type { Metadata } from "next";
    import "./globals.css";

    export const metadata: Metadata = {
      title: "Pathoma Controller",
      description: "Remote video playback controller",
    };

    export default function RootLayout({
      children,
    }: {
      children: React.ReactNode;
    }) {
      return (
        <html lang="en">
          <body>{children}</body>
        </html>
      );
    }
    ```

    2. Update app/page.tsx with a placeholder:
    ```typescript
    export default function Home() {
      return (
        <main className="min-h-screen flex items-center justify-center">
          <div className="text-center">
            <h1 className="text-2xl font-bold">Pathoma Controller</h1>
            <p className="text-gray-600 mt-2">Backend foundation in progress...</p>
          </div>
        </main>
      );
    }
    ```

    3. Create convex/README.md documenting the schema for future reference:
    ```markdown
    # Convex Backend

    ## Schema

    ### users
    Authorized email allowlist. Admin adds entries directly in Convex dashboard.
    - `email`: string (indexed)
    - `name`: optional string
    - `createdAt`: number (timestamp)

    ### commands
    Video control commands from web app to extension.
    - `type`: "play" | "pause" | "seekForward" | "seekBackward" | "speedUp" | "speedDown"
    - `amount`: optional number (seconds for seek, delta for speed)
    - `userId`: string (Clerk user ID)
    - `createdAt`: number (timestamp, indexed)
    - `acknowledged`: boolean
    - `acknowledgedAt`: optional number
    ```
  </action>
  <verify>
    - `npm run dev` starts without errors
    - Visit http://localhost:3000 shows "Pathoma Controller" heading
  </verify>
  <done>
    Next.js app shell ready for Clerk/Convex provider integration in Plan 02.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. `npm run dev` starts dev server
3. Convex dashboard shows users and commands tables
4. .env.local contains CONVEX_DEPLOYMENT and NEXT_PUBLIC_CONVEX_URL
</verification>

<success_criteria>
- Next.js 14+ project with TypeScript and Tailwind
- Convex SDK installed and initialized
- Clerk SDK installed
- Convex schema deployed with users and commands tables
- Project builds and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-01-SUMMARY.md`
</output>
